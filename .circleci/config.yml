version: 2.1
orbs:
  aws-cli: circleci/aws-cli@3.1.3

commands:
  install_dep:
    steps:
      - run:
          name: install dependencies
          command: |
            make install
            # Install hadolint
            wget -O /bin/hadolint https://github.com/hadolint/hadolint/releases/download/v1.16.3/hadolint-Linux-x86_64 &&\
                chmod +x /bin/hadolint
  install_ansible:
    description: Install Ansible
    steps:
      - run: 
          name: Install Ansible
          command: |
            sudo apt update
            sudo apt install software-properties-common -y
            sudo add-apt-repository --yes --update ppa:ansible/ansible
            sudo apt install ansible -y
  destroy-environment:
    description: app cloudformation stacks given a workflow ID.
    parameters:
      Workflow_ID:
        type: string 
        default: ${CIRCLE_WORKFLOW_ID:0:7}
    steps:
      - run:
          name: Destroy environments
          when: on_fail
          command: |
            aws cloudformation delete-stack --stack-name "capstone-<< parameters.Workflow_ID >>"
  revert-migrations:
    description: Revert the last migration
    parameters:
      Workflow_ID:
        type: string
        default: ${CIRCLE_WORKFLOW_ID:0:7}
    steps:
      - run:
          name: Revert migrations
          when: on_fail 
          command: |
            SUCCESS=$(curl --insecure  https://kvdb.io/${KVDB_BUCKET}/migration_<< parameters.Workflow_ID >>)
            # Logic for reverting the database state 
            if (( $SUCCESS == 1 )); 
            then
            fi
jobs:
  linkcheck-mkdocs:
    docker:
      - image: python:3.7.15
    steps:
      - checkout
      - install_dep
      - run:
          name: Mkdocs linkcheck
          command: |
            if [[ `mkdocs-linkcheck docs  | grep "Broken" | awk {'print $3'}` -eq 0 ]]
            then
              exit 0
            else
              exit 1
            fi   

  build-mkdocs:
    docker:
      - image: python:3.7.15
    steps:
      - checkout
      - install_dep
      # Download and cache dependencies
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "requirements.txt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies-
      - run:
          name: Build mkdocs static page
          command: |
            mkdocs build
      - save_cache:
          paths:
            - ./venv
          key: v1-dependencies-{{ checksum "requirements.txt" }}

  deploy-infra:
    executor: aws-cli/default
    steps:
      - checkout
      - aws-cli/setup:
        profile-name: capstone
      - run:
          name: Ensure infrastructure exists
          command: |
            aws cloudformation deploy \
              --template-file .circleci/files/infra.yml \
              --tags project=capstone \
              --stack-name "capstone-${CIRCLE_WORKFLOW_ID:0:7}" \
              --parameter-overrides ID="${CIRCLE_WORKFLOW_ID:0:7}"
      - destroy-environment

  run-migrations:
    docker:
      - image: python:3.7.15
    steps:
      - checkout
      - run:
          name: Mkdocs linkcheck
          command: |
            if [[ `mkdocs-linkcheck docs  | grep "Broken" | awk {'print $3'}` -eq 0 ]]
            then
              exit 0
            else
              exit 1
            fi  

  deploy-mkdocs:
    docker:
      - image: python:3.7.15
    steps:
      - checkout
      - install_awscli
      - run:
          name: Deploy frontend objects
          command: |
            cd /app/site
            aws s3 cp . s3://capstone-${CIRCLE_WORKFLOW_ID:0:7} --recursive
      - destroy-environment
      - revert-migrations     

  smoke-test:
    docker:
      - image: python:3.7.15
    steps:
      - checkout
      - run:
          name: Frontend smoke test.
          command: |
            FRONTEND_WEBSITE=http://capstone-${CIRCLE_WORKFLOW_ID:0:7}.s3-website.${AWS_DEFAULT_REGION}.amazonaws.com
            if curl -s $FRONTEND_WEBSITE | grep "Welcome"
            then
              exit 0
            else
              exit 1
            fi
      - destroy-environment
      - revert-migrations

  cloudfront-update:
    docker:
      - image: python:3.7.15
    steps:
      - checkout
      - install_awscli
      - run:
          name: Save Old Workflow ID to kvdb.io
          command: |
            export OLD_WORKFLOW_ID=$(aws cloudformation \
                      list-exports --query "Exports[?Name==\`WorkflowID\`].Value" \
                      --no-paginate --output text)
            echo "Old Wokflow ID: $OLD_WORKFLOW_ID"
            curl https://kvdb.io/${KVDB_BUCKET}/old_workflow_id -d "${OLD_WORKFLOW_ID}"
      - run:
          name: Update cloudfront distribution
          command: |
            aws cloudformation deploy \
              --template-file .circleci/files/cloudfront.yml \
              --parameter-overrides WorkflowID="${CIRCLE_WORKFLOW_ID:0:7}" \
              --stack-name InitialStack      
      - destroy-environment
      - revert-migrations

  clean-up:
    docker:
      - image: python:3.7.15
    steps:
      - checkout
      - run:
          name: Mkdocs linkcheck
          command: |
            if [[ `mkdocs-linkcheck docs  | grep "Broken" | awk {'print $3'}` -eq 0 ]]
            then
              exit 0
            else
              exit 1
            fi  


workflows:
  default:
    jobs:
      - linkcheck-mkdocs
      - build-mkdocs:
          requires: [linkcheck-mkdocs]
      - deploy-infra:
          requires: [build-mkdocs]
          filters:
            branches:
              only: [main]
      - run-migrations:
          requires: [deploy-infra]
      - deploy-mkdocs:
          requires: [run-migrations]
      - smoke-test:
          requires: [deploy-mkdocs]
      - cloudfront-update:
          requires: [smoke-test]
      - clean-up:
          requires: [cloudfront-update]


